# 1. 备份和恢复

为什么要备份  
灾难恢复：硬件故障、软件故障、自然灾害、黑客攻击、误操作测试等数据丢失场景。

备份注意要点  
- 能容忍最多丢失多少数据
- 恢复数据需要在多长时间内完成
- 需要恢复哪些数据

还原要点
- 做还原测试，用于测试备份的可用性
- 还原演练

备份类型：  
完整备份，部分备份  
- 完整备份：整个数据集。
- 部分备份：只备份数据子集，如部分库或表。

完全备份、增量备份、差异备份
- 增量备份：仅备份最近一次完全备份或增量备份（如果存在增量）以来变化的数据，备份较快，还原复杂。
- 差异备份：仅备份最近一次完全备份以来变化的数据，备份较慢，还原简单。

注意：二进制日志文件不应该与数据文件放在同一磁盘。

冷、温、热备份
- 冷备：读写操作均不可进行。
- 温备：读操作可执行；但写操作不可执行。
- 热备：读写操作均可执行。

MyISAM：温备，不支持热备。  
InnoDB：都支持。

物理和逻辑备份
- 物理备份：直接复制数据文件进行备份，与存储引擎有关，占用较多的空间，速度快。
- 逻辑备份：从数据库中“导出”数据另存而进行的备份，与存储引擎无关，占用空间少，速度慢，可能丢失精度。

备份时需要考虑的因素
- 温备的持锁多久
- 备份产生的负载
- 备份过程的时长
- 恢复过程的时长

备份什么
- 数据
- 二进制日志、InnoDB 的事务日志
- 程序代码（存储过程、函数、触发器、事件调度器）
- 服务器的配置文件

# 2. 备份工具

|备份工具|描述|
|:-|:-|
|cp, tar等复制归档工具|物理备份工具，适用所有存储引擎；<br>只支持冷备；<br>完全和部分备份。|
|LVM的快照|先加锁，做快照后解锁，几乎热备；<br>借助文件系统工具进行备份。|
|mysqldump|逻辑备份工具，适用所有存储引擎，温备；<br>支持完全或部分备份；<br>对 InnoDB 存储引擎支持热备，结合 binlog 的增量备份。|
|xtrabackup|由 Percona 提供支持对 InnoDB 做热备(物理备份)的工具；支持完全备份、增量备份。|
|MariaDB Backup| 从 MariaDB 10.1.26开始集成，基于 Percona　XtraBackup 2.3.8实现。|
|mysqlbackup|热备份，MySQL Enterprise Edition 组件。|
|mysqlhotcopy|PERL 语言实现，几乎冷备，仅适用于 MyISAM 存储引擎，使用 LOCK TABLES、FLUSH TABLES　和 cp 或 scp 来快速备份数据库。|

# 3. 基于LVM的备份

(1) 请求锁定所有表
```
mysql> FLUSH TABLES WITH READ LOCK;
```

(2) 记录二进制日志文件及事件位置
```
mysql> FLUSH LOGS;
mysql> SHOW MASTER STATUS;
mysql -e 'SHOW MASTER STATUS' > /PATH/TO/SOMEFILE
```

(3) 创建快照
```
lvcreate -L # -s -p r -n NAME /DEV/VG_NAME/LV_NAME
```

(4) 释放锁
```
mysql> UNLOCK TABLES;
```

(5) 挂载快照卷，执行数据备份

(6) 备份完成后，删除快照卷

(7) 制定好策略，通过原卷备份二进制日志